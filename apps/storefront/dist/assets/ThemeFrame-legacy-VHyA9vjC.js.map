{"version":3,"file":"ThemeFrame-legacy-VHyA9vjC.js","sources":["../../src/components/ThemeFrame.tsx"],"sourcesContent":["import { ReactNode, RefObject, useEffect, useRef, useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport createCache, { EmotionCache } from '@emotion/cache';\nimport { CacheProvider } from '@emotion/react';\nimport { CssBaseline } from '@mui/material';\n\nimport { clearThemeFrame, setThemeFrame, useAppDispatch } from '@/store';\n\nexport function IFrameSetContent(\n  el: HTMLIFrameElement | null,\n  content: string,\n  forceWrite = false,\n) {\n  if (el) {\n    const element = el;\n    if ('srcdoc' in HTMLIFrameElement.prototype && !forceWrite) {\n      element.srcdoc = content;\n    } else {\n      const iframeDoc = element.contentDocument;\n      iframeDoc?.open('text/html', 'replace');\n      iframeDoc?.write(content);\n      iframeDoc?.close();\n    }\n  }\n}\n\nconst handleLoad = (_iframeRef: RefObject<HTMLIFrameElement>) => {\n  // resolve iframe use document mousedown no effect\n  if (_iframeRef.current?.contentDocument?.addEventListener) {\n    _iframeRef.current.contentDocument.addEventListener('keydown', () => {\n      document.dispatchEvent(new Event('keydown'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('mousedown', () => {\n      document.dispatchEvent(new Event('mousedown'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('touchstart', () => {\n      document.dispatchEvent(new Event('touchstart'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('touchmove', () => {\n      document.dispatchEvent(new Event('touchmove'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('click', () => {\n      document.dispatchEvent(new Event('click'));\n    });\n  }\n};\n\ninterface ThemeFrameProps {\n  children: ReactNode; // children to be rendered within iframe\n  className?: string; // className to assign the iframe\n  bodyRef?: RefObject<HTMLBodyElement>; // if the parent needs access to body of iframe. i.e to attach dom event handlers\n  fontUrl?: string;\n  customStyles?: string;\n  title?: string;\n}\ninterface ThemeFramePortalProps {\n  children: ReactNode;\n  isSetupComplete: boolean;\n  emotionCache?: EmotionCache;\n  iframeDocument?: HTMLIFrameElement['contentDocument'];\n  bodyRef?: RefObject<HTMLBodyElement>;\n}\n\nconst DefaultIframeContent = '<!DOCTYPE html><html><head></head><body></body></html>';\n\nfunction ThemeFramePortal(props: ThemeFramePortalProps) {\n  const dispatch = useAppDispatch();\n  const { isSetupComplete, emotionCache, iframeDocument, bodyRef, children } = props;\n\n  useEffect(() => {\n    if (iframeDocument) {\n      dispatch(setThemeFrame(iframeDocument));\n    }\n    return () => {\n      if (iframeDocument) {\n        dispatch(clearThemeFrame());\n      }\n    };\n    // disabling because dispatch is not needed in the dependency array\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [iframeDocument]);\n\n  if (!isSetupComplete || !emotionCache || !iframeDocument) {\n    return null;\n  }\n\n  if (bodyRef?.current !== undefined) {\n    // eslint-disable-next-line\n    // @ts-ignore - we are intentionally setting ref passed from parent\n    bodyRef.current = iframeDocument.body;\n  }\n\n  return createPortal(\n    <CacheProvider value={emotionCache}>\n      <CssBaseline />\n      {children}\n    </CacheProvider>,\n    iframeDocument.body,\n  );\n}\n\nexport default function ThemeFrame(props: ThemeFrameProps) {\n  const { title, className, fontUrl, customStyles, children, bodyRef } = props;\n  const iframeRef = useRef<HTMLIFrameElement>(null);\n  const [isSetupComplete, setIsSetupComplete] = useState(false);\n  const [emotionCache, setEmotionCache] = useState<EmotionCache | undefined>(undefined);\n\n  useEffect(() => {\n    const iframe = iframeRef.current;\n    if (!iframe) {\n      return;\n    }\n\n    IFrameSetContent(iframe, DefaultIframeContent, true);\n    const doc = iframeRef.current?.contentDocument;\n    if (!doc) {\n      return;\n    }\n\n    if (fontUrl) {\n      const font = doc.createElement('link');\n      font.rel = 'stylesheet';\n      font.href = fontUrl;\n      doc.head.appendChild(font);\n    }\n    if (customStyles) {\n      const customStyleElement = doc.createElement('style');\n      customStyleElement.appendChild(document.createTextNode(customStyles));\n      doc.head.appendChild(customStyleElement);\n    }\n\n    const emotionCacheObj = createCache({\n      key: 'css',\n      container: doc.head,\n      prepend: true,\n    });\n\n    setEmotionCache(emotionCacheObj);\n\n    if (doc.readyState === 'complete') {\n      handleLoad(iframeRef);\n    } else {\n      iframeRef.current?.addEventListener('load', () => handleLoad(iframeRef));\n    }\n\n    setIsSetupComplete(true);\n    const currentFrame = iframeRef.current;\n    // eslint-disable-next-line\n    return () => {\n      setIsSetupComplete(false);\n      currentFrame?.removeEventListener('load', () => {\n        handleLoad(iframeRef);\n      });\n    };\n    // disabling cause it needs to be run once\n  }, [customStyles, fontUrl]);\n\n  return (\n    <iframe\n      allowFullScreen\n      className={isSetupComplete ? className : undefined}\n      title={title}\n      ref={iframeRef}\n    >\n      <ThemeFramePortal\n        isSetupComplete={isSetupComplete}\n        emotionCache={emotionCache}\n        iframeDocument={iframeRef.current?.contentDocument}\n        bodyRef={bodyRef}\n      >\n        {children}\n      </ThemeFramePortal>\n    </iframe>\n  );\n}\n"],"names":["IFrameSetContent","el","content","forceWrite","element","HTMLIFrameElement","prototype","srcdoc","iframeDoc","contentDocument","open","write","close","props","title","className","fontUrl","customStyles","children","bodyRef","iframeRef","useRef","isSetupComplete","setIsSetupComplete","useState","emotionCache","setEmotionCache","useEffect","iframe","current","DefaultIframeContent","doc","font","createElement","rel","href","head","appendChild","customStyleElement","document","createTextNode","emotionCacheObj","createCache","key","container","prepend","readyState","handleLoad","addEventListener","currentFrame","removeEventListener","jsx","allowFullScreen","ref","ThemeFramePortal","iframeDocument","_iframeRef","dispatchEvent","Event","dispatch","useAppDispatch","setThemeFrame","clearThemeFrame","body","createPortal","jsxs","CacheProvider","value","CssBaseline"],"mappings":"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"}