{"version":3,"file":"ThemeFrame-s-lHoEUE.js","sources":["../../src/components/ThemeFrame.tsx"],"sourcesContent":["import { ReactNode, RefObject, useEffect, useRef, useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport createCache, { EmotionCache } from '@emotion/cache';\nimport { CacheProvider } from '@emotion/react';\nimport { CssBaseline } from '@mui/material';\n\nimport { clearThemeFrame, setThemeFrame, useAppDispatch } from '@/store';\n\nexport function IFrameSetContent(\n  el: HTMLIFrameElement | null,\n  content: string,\n  forceWrite = false,\n) {\n  if (el) {\n    const element = el;\n    if ('srcdoc' in HTMLIFrameElement.prototype && !forceWrite) {\n      element.srcdoc = content;\n    } else {\n      const iframeDoc = element.contentDocument;\n      iframeDoc?.open('text/html', 'replace');\n      iframeDoc?.write(content);\n      iframeDoc?.close();\n    }\n  }\n}\n\nconst handleLoad = (_iframeRef: RefObject<HTMLIFrameElement>) => {\n  // resolve iframe use document mousedown no effect\n  if (_iframeRef.current?.contentDocument?.addEventListener) {\n    _iframeRef.current.contentDocument.addEventListener('keydown', () => {\n      document.dispatchEvent(new Event('keydown'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('mousedown', () => {\n      document.dispatchEvent(new Event('mousedown'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('touchstart', () => {\n      document.dispatchEvent(new Event('touchstart'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('touchmove', () => {\n      document.dispatchEvent(new Event('touchmove'));\n    });\n    _iframeRef.current.contentDocument.addEventListener('click', () => {\n      document.dispatchEvent(new Event('click'));\n    });\n  }\n};\n\ninterface ThemeFrameProps {\n  children: ReactNode; // children to be rendered within iframe\n  className?: string; // className to assign the iframe\n  bodyRef?: RefObject<HTMLBodyElement>; // if the parent needs access to body of iframe. i.e to attach dom event handlers\n  fontUrl?: string;\n  customStyles?: string;\n  title?: string;\n}\ninterface ThemeFramePortalProps {\n  children: ReactNode;\n  isSetupComplete: boolean;\n  emotionCache?: EmotionCache;\n  iframeDocument?: HTMLIFrameElement['contentDocument'];\n  bodyRef?: RefObject<HTMLBodyElement>;\n}\n\nconst DefaultIframeContent = '<!DOCTYPE html><html><head></head><body></body></html>';\n\nfunction ThemeFramePortal(props: ThemeFramePortalProps) {\n  const dispatch = useAppDispatch();\n  const { isSetupComplete, emotionCache, iframeDocument, bodyRef, children } = props;\n\n  useEffect(() => {\n    if (iframeDocument) {\n      dispatch(setThemeFrame(iframeDocument));\n    }\n    return () => {\n      if (iframeDocument) {\n        dispatch(clearThemeFrame());\n      }\n    };\n    // disabling because dispatch is not needed in the dependency array\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [iframeDocument]);\n\n  if (!isSetupComplete || !emotionCache || !iframeDocument) {\n    return null;\n  }\n\n  if (bodyRef?.current !== undefined) {\n    // eslint-disable-next-line\n    // @ts-ignore - we are intentionally setting ref passed from parent\n    bodyRef.current = iframeDocument.body;\n  }\n\n  return createPortal(\n    <CacheProvider value={emotionCache}>\n      <CssBaseline />\n      {children}\n    </CacheProvider>,\n    iframeDocument.body,\n  );\n}\n\nexport default function ThemeFrame(props: ThemeFrameProps) {\n  const { title, className, fontUrl, customStyles, children, bodyRef } = props;\n  const iframeRef = useRef<HTMLIFrameElement>(null);\n  const [isSetupComplete, setIsSetupComplete] = useState(false);\n  const [emotionCache, setEmotionCache] = useState<EmotionCache | undefined>(undefined);\n\n  useEffect(() => {\n    const iframe = iframeRef.current;\n    if (!iframe) {\n      return;\n    }\n\n    IFrameSetContent(iframe, DefaultIframeContent, true);\n    const doc = iframeRef.current?.contentDocument;\n    if (!doc) {\n      return;\n    }\n\n    if (fontUrl) {\n      const font = doc.createElement('link');\n      font.rel = 'stylesheet';\n      font.href = fontUrl;\n      doc.head.appendChild(font);\n    }\n    if (customStyles) {\n      const customStyleElement = doc.createElement('style');\n      customStyleElement.appendChild(document.createTextNode(customStyles));\n      doc.head.appendChild(customStyleElement);\n    }\n\n    const emotionCacheObj = createCache({\n      key: 'css',\n      container: doc.head,\n      prepend: true,\n    });\n\n    setEmotionCache(emotionCacheObj);\n\n    if (doc.readyState === 'complete') {\n      handleLoad(iframeRef);\n    } else {\n      iframeRef.current?.addEventListener('load', () => handleLoad(iframeRef));\n    }\n\n    setIsSetupComplete(true);\n    const currentFrame = iframeRef.current;\n    // eslint-disable-next-line\n    return () => {\n      setIsSetupComplete(false);\n      currentFrame?.removeEventListener('load', () => {\n        handleLoad(iframeRef);\n      });\n    };\n    // disabling cause it needs to be run once\n  }, [customStyles, fontUrl]);\n\n  return (\n    <iframe\n      allowFullScreen\n      className={isSetupComplete ? className : undefined}\n      title={title}\n      ref={iframeRef}\n    >\n      <ThemeFramePortal\n        isSetupComplete={isSetupComplete}\n        emotionCache={emotionCache}\n        iframeDocument={iframeRef.current?.contentDocument}\n        bodyRef={bodyRef}\n      >\n        {children}\n      </ThemeFramePortal>\n    </iframe>\n  );\n}\n"],"names":["IFrameSetContent","el","content","forceWrite","element","iframeDoc","handleLoad","_iframeRef","_b","_a","DefaultIframeContent","ThemeFramePortal","props","dispatch","useAppDispatch","isSetupComplete","emotionCache","iframeDocument","bodyRef","children","useEffect","setThemeFrame","clearThemeFrame","createPortal","jsxs","CacheProvider","jsx","CssBaseline","ThemeFrame","title","className","fontUrl","customStyles","iframeRef","useRef","setIsSetupComplete","useState","setEmotionCache","iframe","doc","font","customStyleElement","emotionCacheObj","createCache","currentFrame"],"mappings":"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"}