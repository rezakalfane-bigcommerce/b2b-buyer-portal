{"version":3,"file":"headless-legacy.js","sources":["../src/utils/headlessInitializer.ts","../src/headless.ts"],"sourcesContent":["import { getAPIBaseURL } from '../shared/service/request/base';\nimport { Environment } from '../types';\n\nconst BUYER_PORTAL_INJECTED_SCRIPT_CLASS = `buyer-portal-scripts-headless`;\n\nexport async function initHeadlessScripts() {\n  const parseAndInsertStorefrontScripts = (storefrontScripts: string) => {\n    const b2bScriptDocument = new DOMParser().parseFromString(storefrontScripts, 'text/html');\n    const b2bScriptNodes = b2bScriptDocument.querySelectorAll('script');\n\n    if (b2bScriptNodes.length > 0) {\n      const existingBuyerPortalScriptNodes = document.querySelectorAll(\n        `script.${BUYER_PORTAL_INJECTED_SCRIPT_CLASS}`,\n      );\n      if (existingBuyerPortalScriptNodes.length > 0) {\n        existingBuyerPortalScriptNodes.forEach((oldNode) => {\n          oldNode.parentNode?.removeChild(oldNode);\n        });\n      }\n\n      b2bScriptNodes.forEach((node) => {\n        const scriptElement = document.createElement('script');\n        [...node.attributes].forEach((attr) => {\n          scriptElement.setAttribute(attr.nodeName, attr.nodeValue as string);\n        });\n        scriptElement.innerHTML = node.innerHTML;\n        scriptElement.className = BUYER_PORTAL_INJECTED_SCRIPT_CLASS;\n        document.body.appendChild(scriptElement);\n      });\n    }\n  };\n\n  async function getScriptContent(originUrl: string): Promise<string> {\n    // cSpell:ignore storehash, channelid\n    const headlessScriptNode: HTMLElement | null = document.querySelector(\n      'script[data-storehash][data-channelid]',\n    );\n    const params: {\n      siteUrl: string;\n      storeHash: string;\n      channelId: string;\n      environment?: Environment;\n    } = {\n      siteUrl: originUrl,\n      storeHash: headlessScriptNode?.dataset?.storehash ?? '',\n      channelId: headlessScriptNode?.dataset?.channelid ?? '',\n      environment: headlessScriptNode?.dataset?.environment as Environment,\n    };\n    const response = await fetch(`${getAPIBaseURL(params.environment)}/graphql`, {\n      method: 'POST',\n      headers: {\n        'content-type': 'application/json',\n      },\n      body: JSON.stringify({\n        query: `\n          {\n            storefrontScript(\n              storeHash: \"${params.storeHash}\"\n              channelId: ${params.channelId}\n              siteUrl: \"${params.siteUrl}\"\n            ) {\n              script\n              storeHash\n              channelId\n            }\n          }`,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error('network error');\n    }\n\n    const {\n      data: { storefrontScript },\n    } = await response.json();\n    return storefrontScript.script;\n  }\n\n  const scriptContent = await getScriptContent(window.location.origin);\n  parseAndInsertStorefrontScripts(scriptContent);\n}\n","import b2bLogger from './utils/b3Logger';\nimport { initHeadlessScripts } from './utils/headlessInitializer';\n\ninitHeadlessScripts().catch((error: TypeError) => {\n  b2bLogger.error(`unexpected error during headless buyer portal initialization`, error);\n});\n"],"names":["BUYER_PORTAL_INJECTED_SCRIPT_CLASS","async","storefrontScripts","b2bScriptNodes","DOMParser","parseFromString","querySelectorAll","length","existingBuyerPortalScriptNodes","document","forEach","oldNode","parentNode","removeChild","node","scriptElement","createElement","attributes","attr","setAttribute","nodeName","nodeValue","innerHTML","className","body","appendChild","parseAndInsertStorefrontScripts","originUrl","headlessScriptNode","querySelector","params","siteUrl","storeHash","dataset","storehash","channelId","channelid","environment","response","fetch","getAPIBaseURL","method","headers","JSON","stringify","query","ok","Error","data","storefrontScript","json","script","getScriptContent","window","location","origin","initHeadlessScripts","catch","error","b2bLogger"],"mappings":"wLAGA,MAAMA,EAAqC,iCAE3CC,iBAC2CC,KACvC,MACMC,GADoB,IAAIC,WAAYC,gBAAgBH,EAAmB,aACpCI,iBAAiB,UAEtD,GAAAH,EAAeI,OAAS,EAAG,CAC7B,MAAMC,EAAiCC,SAASH,iBAC9C,UAAUN,KAERQ,EAA+BD,OAAS,GACXC,EAAAE,SAASC,IAC9BA,EAAAC,YAAYC,YAAYF,EAAO,IAI5BR,EAAAO,SAASI,IAChB,MAAAC,EAAgBN,SAASO,cAAc,UAC7C,IAAIF,EAAKG,YAAYP,SAASQ,IAC5BH,EAAcI,aAAaD,EAAKE,SAAUF,EAAKG,UAAmB,IAEpEN,EAAcO,UAAYR,EAAKQ,UAC/BP,EAAcQ,UAAYvB,EACjBS,SAAAe,KAAKC,YAAYV,EAAa,GACxC,GAoDLW,OAhDAzB,eAAgC0B,GAE9B,MAAMC,EAAyCnB,SAASoB,cACtD,0CAEIC,EAKF,CACFC,QAASJ,EACTK,UAAWJ,GAAoBK,SAASC,WAAa,GACrDC,UAAWP,GAAoBK,SAASG,WAAa,GACrDC,YAAaT,GAAoBK,SAASI,aAEtCC,QAAiBC,MAAM,GAAGC,EAAcV,EAAOO,uBAAwB,CAC3EI,OAAQ,OACRC,QAAS,CACP,eAAgB,oBAElBlB,KAAMmB,KAAKC,UAAU,CACnBC,MAAO,2EAGaf,EAAOE,wCACRF,EAAOK,sCACRL,EAAOC,oIAUzB,IAACO,EAASQ,GACN,UAAIC,MAAM,iBAGZ,MACJC,MAAMC,iBAAEA,UACAX,EAASY,OACnB,OAAOD,EAAiBE,MAAA,CAGEC,CAAiBC,OAAOC,SAASC,QAE/D,EC9EAC,GAAsBC,OAAOC,IACjBC,EAAAD,MAAM,+DAAgEA,EAAK"}