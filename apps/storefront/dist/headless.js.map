{"version":3,"file":"headless.js","sources":["../src/utils/headlessInitializer.ts","../src/headless.ts"],"sourcesContent":["import { getAPIBaseURL } from '../shared/service/request/base';\nimport { Environment } from '../types';\n\nconst BUYER_PORTAL_INJECTED_SCRIPT_CLASS = `buyer-portal-scripts-headless`;\n\nexport async function initHeadlessScripts() {\n  const parseAndInsertStorefrontScripts = (storefrontScripts: string) => {\n    const b2bScriptDocument = new DOMParser().parseFromString(storefrontScripts, 'text/html');\n    const b2bScriptNodes = b2bScriptDocument.querySelectorAll('script');\n\n    if (b2bScriptNodes.length > 0) {\n      const existingBuyerPortalScriptNodes = document.querySelectorAll(\n        `script.${BUYER_PORTAL_INJECTED_SCRIPT_CLASS}`,\n      );\n      if (existingBuyerPortalScriptNodes.length > 0) {\n        existingBuyerPortalScriptNodes.forEach((oldNode) => {\n          oldNode.parentNode?.removeChild(oldNode);\n        });\n      }\n\n      b2bScriptNodes.forEach((node) => {\n        const scriptElement = document.createElement('script');\n        [...node.attributes].forEach((attr) => {\n          scriptElement.setAttribute(attr.nodeName, attr.nodeValue as string);\n        });\n        scriptElement.innerHTML = node.innerHTML;\n        scriptElement.className = BUYER_PORTAL_INJECTED_SCRIPT_CLASS;\n        document.body.appendChild(scriptElement);\n      });\n    }\n  };\n\n  async function getScriptContent(originUrl: string): Promise<string> {\n    // cSpell:ignore storehash, channelid\n    const headlessScriptNode: HTMLElement | null = document.querySelector(\n      'script[data-storehash][data-channelid]',\n    );\n    const params: {\n      siteUrl: string;\n      storeHash: string;\n      channelId: string;\n      environment?: Environment;\n    } = {\n      siteUrl: originUrl,\n      storeHash: headlessScriptNode?.dataset?.storehash ?? '',\n      channelId: headlessScriptNode?.dataset?.channelid ?? '',\n      environment: headlessScriptNode?.dataset?.environment as Environment,\n    };\n    const response = await fetch(`${getAPIBaseURL(params.environment)}/graphql`, {\n      method: 'POST',\n      headers: {\n        'content-type': 'application/json',\n      },\n      body: JSON.stringify({\n        query: `\n          {\n            storefrontScript(\n              storeHash: \"${params.storeHash}\"\n              channelId: ${params.channelId}\n              siteUrl: \"${params.siteUrl}\"\n            ) {\n              script\n              storeHash\n              channelId\n            }\n          }`,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error('network error');\n    }\n\n    const {\n      data: { storefrontScript },\n    } = await response.json();\n    return storefrontScript.script;\n  }\n\n  const scriptContent = await getScriptContent(window.location.origin);\n  parseAndInsertStorefrontScripts(scriptContent);\n}\n","import b2bLogger from './utils/b3Logger';\nimport { initHeadlessScripts } from './utils/headlessInitializer';\n\ninitHeadlessScripts().catch((error: TypeError) => {\n  b2bLogger.error(`unexpected error during headless buyer portal initialization`, error);\n});\n"],"names":["BUYER_PORTAL_INJECTED_SCRIPT_CLASS","initHeadlessScripts","parseAndInsertStorefrontScripts","storefrontScripts","b2bScriptNodes","existingBuyerPortalScriptNodes","oldNode","_a","node","scriptElement","attr","getScriptContent","originUrl","headlessScriptNode","params","_b","_d","_c","_e","response","getAPIBaseURL","storefrontScript","scriptContent","error","b2bLogger"],"mappings":"4KAGA,MAAMA,EAAqC,gCAE3C,eAAsBC,GAAsB,CACpC,MAAAC,EAAmCC,GAA8B,CAE/D,MAAAC,EADoB,IAAI,UAAA,EAAY,gBAAgBD,EAAmB,WAAW,EAC/C,iBAAiB,QAAQ,EAE9D,GAAAC,EAAe,OAAS,EAAG,CAC7B,MAAMC,EAAiC,SAAS,iBAC9C,UAAU,OAAAL,EACZ,EACIK,EAA+B,OAAS,GACXA,EAAA,QAASC,GAAY,QAC1CC,EAAAD,EAAA,aAAA,MAAAC,EAAY,YAAYD,EAAO,CACxC,EAGYF,EAAA,QAASI,GAAS,CACzB,MAAAC,EAAgB,SAAS,cAAc,QAAQ,EACrD,CAAC,GAAGD,EAAK,UAAU,EAAE,QAASE,GAAS,CACrCD,EAAc,aAAaC,EAAK,SAAUA,EAAK,SAAmB,CAAA,CACnE,EACDD,EAAc,UAAYD,EAAK,UAC/BC,EAAc,UAAYT,EACjB,SAAA,KAAK,YAAYS,CAAa,CAAA,CACxC,CAAA,CAEL,EAEA,eAAeE,EAAiBC,EAAoC,eAElE,MAAMC,EAAyC,SAAS,cACtD,wCACF,EACMC,EAKF,CACF,QAASF,EACT,WAAWG,GAAAR,EAAAM,GAAA,YAAAA,EAAoB,UAApB,YAAAN,EAA6B,YAA7B,KAAAQ,EAA0C,GACrD,WAAWC,GAAAC,EAAAJ,GAAA,YAAAA,EAAoB,UAApB,YAAAI,EAA6B,YAA7B,KAAAD,EAA0C,GACrD,aAAaE,EAAAL,GAAA,YAAAA,EAAoB,UAApB,YAAAK,EAA6B,WAC5C,EACMC,EAAW,MAAM,MAAM,GAAG,OAAAC,EAAcN,EAAO,WAAW,EAAC,YAAY,CAC3E,OAAQ,OACR,QAAS,CACP,eAAgB,kBAClB,EACA,KAAM,KAAK,UAAU,CACnB,MAAO,2EAGa,OAAAA,EAAO,UAAS,gCACjB,OAAAA,EAAO,UAAS,8BACjB,OAAAA,EAAO,QAAO,yHAOjC,CAAA,CAAA,CACF,EAEG,GAAA,CAACK,EAAS,GACN,MAAA,IAAI,MAAM,eAAe,EAG3B,KAAA,CACJ,KAAM,CAAE,iBAAAE,CAAiB,CAAA,EACvB,MAAMF,EAAS,KAAK,EACxB,OAAOE,EAAiB,MAAA,CAG1B,MAAMC,EAAgB,MAAMX,EAAiB,OAAO,SAAS,MAAM,EACnET,EAAgCoB,CAAa,CAC/C,CC9EArB,IAAsB,MAAOsB,GAAqB,CACtCC,EAAA,MAAM,+DAAgED,CAAK,CACvF,CAAC"}